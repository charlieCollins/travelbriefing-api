//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: ../target/dependency/okio/GzipSink.java
//

#include "IOSPrimitiveArray.h"
#include "J2ObjC_source.h"
#include "java/lang/IllegalArgumentException.h"
#include "java/lang/Math.h"
#include "java/util/zip/CRC32.h"
#include "java/util/zip/Deflater.h"
#include "okio/Buffer.h"
#include "okio/BufferedSink.h"
#include "okio/DeflaterSink.h"
#include "okio/GzipSink.h"
#include "okio/Okio.h"
#include "okio/Segment.h"
#include "okio/Sink.h"
#include "okio/Timeout.h"
#include "okio/Util.h"

@interface OkioGzipSink () {
 @public
  id<OkioBufferedSink> sink_;
  JavaUtilZipDeflater *deflater_;
  OkioDeflaterSink *deflaterSink_;
  jboolean closed_;
  JavaUtilZipCRC32 *crc_;
}

- (void)writeHeader;

- (void)writeFooter;

- (void)updateCrcWithOkioBuffer:(OkioBuffer *)buffer
                       withLong:(jlong)byteCount;

@end

J2OBJC_FIELD_SETTER(OkioGzipSink, sink_, id<OkioBufferedSink>)
J2OBJC_FIELD_SETTER(OkioGzipSink, deflater_, JavaUtilZipDeflater *)
J2OBJC_FIELD_SETTER(OkioGzipSink, deflaterSink_, OkioDeflaterSink *)
J2OBJC_FIELD_SETTER(OkioGzipSink, crc_, JavaUtilZipCRC32 *)

__attribute__((unused)) static void OkioGzipSink_writeHeader(OkioGzipSink *self);

__attribute__((unused)) static void OkioGzipSink_writeFooter(OkioGzipSink *self);

__attribute__((unused)) static void OkioGzipSink_updateCrcWithOkioBuffer_withLong_(OkioGzipSink *self, OkioBuffer *buffer, jlong byteCount);

@implementation OkioGzipSink

- (instancetype)initWithOkioSink:(id<OkioSink>)sink {
  OkioGzipSink_initWithOkioSink_(self, sink);
  return self;
}

- (void)writeWithOkioBuffer:(OkioBuffer *)source
                   withLong:(jlong)byteCount {
  if (byteCount < 0) @throw create_JavaLangIllegalArgumentException_initWithNSString_(JreStrcat("$J", @"byteCount < 0: ", byteCount));
  if (byteCount == 0) return;
  OkioGzipSink_updateCrcWithOkioBuffer_withLong_(self, source, byteCount);
  [((OkioDeflaterSink *) nil_chk(deflaterSink_)) writeWithOkioBuffer:source withLong:byteCount];
}

- (void)flush {
  [((OkioDeflaterSink *) nil_chk(deflaterSink_)) flush];
}

- (OkioTimeout *)timeout {
  return [((id<OkioBufferedSink>) nil_chk(sink_)) timeout];
}

- (void)close {
  if (closed_) return;
  NSException *thrown = nil;
  @try {
    [((OkioDeflaterSink *) nil_chk(deflaterSink_)) finishDeflate];
    OkioGzipSink_writeFooter(self);
  }
  @catch (NSException *e) {
    thrown = e;
  }
  @try {
    [((JavaUtilZipDeflater *) nil_chk(deflater_)) end];
  }
  @catch (NSException *e) {
    if (thrown == nil) thrown = e;
  }
  @try {
    [((id<OkioBufferedSink>) nil_chk(sink_)) close];
  }
  @catch (NSException *e) {
    if (thrown == nil) thrown = e;
  }
  closed_ = true;
  if (thrown != nil) OkioUtil_sneakyRethrowWithNSException_(thrown);
}

- (JavaUtilZipDeflater *)deflater {
  return deflater_;
}

- (void)writeHeader {
  OkioGzipSink_writeHeader(self);
}

- (void)writeFooter {
  OkioGzipSink_writeFooter(self);
}

- (void)updateCrcWithOkioBuffer:(OkioBuffer *)buffer
                       withLong:(jlong)byteCount {
  OkioGzipSink_updateCrcWithOkioBuffer_withLong_(self, buffer, byteCount);
}

- (void)dealloc {
  RELEASE_(sink_);
  RELEASE_(deflater_);
  RELEASE_(deflaterSink_);
  RELEASE_(crc_);
  [super dealloc];
}

+ (const J2ObjcClassInfo *)__metadata {
  static J2ObjcMethodInfo methods[] = {
    { NULL, NULL, 0x1, -1, 0, -1, -1, -1, -1 },
    { NULL, "V", 0x1, 1, 2, 3, -1, -1, -1 },
    { NULL, "V", 0x1, -1, -1, 3, -1, -1, -1 },
    { NULL, "LOkioTimeout;", 0x1, -1, -1, -1, -1, -1, -1 },
    { NULL, "V", 0x1, -1, -1, 3, -1, -1, -1 },
    { NULL, "LJavaUtilZipDeflater;", 0x1, -1, -1, -1, -1, -1, -1 },
    { NULL, "V", 0x2, -1, -1, -1, -1, -1, -1 },
    { NULL, "V", 0x2, -1, -1, 3, -1, -1, -1 },
    { NULL, "V", 0x2, 4, 2, -1, -1, -1, -1 },
  };
  #pragma clang diagnostic push
  #pragma clang diagnostic ignored "-Wobjc-multiple-method-names"
  methods[0].selector = @selector(initWithOkioSink:);
  methods[1].selector = @selector(writeWithOkioBuffer:withLong:);
  methods[2].selector = @selector(flush);
  methods[3].selector = @selector(timeout);
  methods[4].selector = @selector(close);
  methods[5].selector = @selector(deflater);
  methods[6].selector = @selector(writeHeader);
  methods[7].selector = @selector(writeFooter);
  methods[8].selector = @selector(updateCrcWithOkioBuffer:withLong:);
  #pragma clang diagnostic pop
  static const J2ObjcFieldInfo fields[] = {
    { "sink_", "LOkioBufferedSink;", .constantValue.asLong = 0, 0x12, -1, -1, -1, -1 },
    { "deflater_", "LJavaUtilZipDeflater;", .constantValue.asLong = 0, 0x12, -1, -1, -1, -1 },
    { "deflaterSink_", "LOkioDeflaterSink;", .constantValue.asLong = 0, 0x12, -1, -1, -1, -1 },
    { "closed_", "Z", .constantValue.asLong = 0, 0x2, -1, -1, -1, -1 },
    { "crc_", "LJavaUtilZipCRC32;", .constantValue.asLong = 0, 0x12, -1, -1, -1, -1 },
  };
  static const void *ptrTable[] = { "LOkioSink;", "write", "LOkioBuffer;J", "LJavaIoIOException;", "updateCrc" };
  static const J2ObjcClassInfo _OkioGzipSink = { "GzipSink", "okio", ptrTable, methods, fields, 7, 0x11, 9, 5, -1, -1, -1, -1, -1 };
  return &_OkioGzipSink;
}

@end

void OkioGzipSink_initWithOkioSink_(OkioGzipSink *self, id<OkioSink> sink) {
  NSObject_init(self);
  JreStrongAssignAndConsume(&self->crc_, new_JavaUtilZipCRC32_init());
  if (sink == nil) @throw create_JavaLangIllegalArgumentException_initWithNSString_(@"sink == null");
  JreStrongAssignAndConsume(&self->deflater_, new_JavaUtilZipDeflater_initWithInt_withBoolean_(JavaUtilZipDeflater_DEFAULT_COMPRESSION, true));
  JreStrongAssign(&self->sink_, OkioOkio_bufferWithOkioSink_(sink));
  JreStrongAssignAndConsume(&self->deflaterSink_, new_OkioDeflaterSink_initWithOkioBufferedSink_withJavaUtilZipDeflater_(self->sink_, self->deflater_));
  OkioGzipSink_writeHeader(self);
}

OkioGzipSink *new_OkioGzipSink_initWithOkioSink_(id<OkioSink> sink) {
  J2OBJC_NEW_IMPL(OkioGzipSink, initWithOkioSink_, sink)
}

OkioGzipSink *create_OkioGzipSink_initWithOkioSink_(id<OkioSink> sink) {
  J2OBJC_CREATE_IMPL(OkioGzipSink, initWithOkioSink_, sink)
}

void OkioGzipSink_writeHeader(OkioGzipSink *self) {
  OkioBuffer *buffer = [((id<OkioBufferedSink>) nil_chk(self->sink_)) buffer];
  [((OkioBuffer *) nil_chk(buffer)) writeShortWithInt:(jint) 0x1f8b];
  [buffer writeByteWithInt:(jint) 0x08];
  [buffer writeByteWithInt:(jint) 0x00];
  [buffer writeIntWithInt:(jint) 0x00];
  [buffer writeByteWithInt:(jint) 0x00];
  [buffer writeByteWithInt:(jint) 0x00];
}

void OkioGzipSink_writeFooter(OkioGzipSink *self) {
  [((id<OkioBufferedSink>) nil_chk(self->sink_)) writeIntLeWithInt:(jint) [((JavaUtilZipCRC32 *) nil_chk(self->crc_)) getValue]];
  [self->sink_ writeIntLeWithInt:(jint) [((JavaUtilZipDeflater *) nil_chk(self->deflater_)) getBytesRead]];
}

void OkioGzipSink_updateCrcWithOkioBuffer_withLong_(OkioGzipSink *self, OkioBuffer *buffer, jlong byteCount) {
  for (OkioSegment *head = ((OkioBuffer *) nil_chk(buffer))->head_; byteCount > 0; head = head->next_) {
    jint segmentLength = (jint) JavaLangMath_minWithLong_withLong_(byteCount, ((OkioSegment *) nil_chk(head))->limit_ - head->pos_);
    [((JavaUtilZipCRC32 *) nil_chk(self->crc_)) updateWithByteArray:head->data_ withInt:head->pos_ withInt:segmentLength];
    byteCount -= segmentLength;
  }
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(OkioGzipSink)
